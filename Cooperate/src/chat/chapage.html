<!DOCTYPE html>
<html lang="en">
<head>
  <script type="text/babel" src="chat.ts"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <link rel="stylesheet" href="chat.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
 <main class='app'>
  <aside class='c-sidepanel'>
    <div class='c-panels'>
      <a class='c-panels__logo' href='' title=''>AM</a>
      
      <nav class='c-panels__navigation'>
        <ul class='c-panels__ul'>
          <li class='c-panels__li'><a class='c-panels__link' href='' title=''><i class="fas fa-search"></i>
</a></li>
          <li class='c-panels__li'><a class='c-panels__link' href='' title=''><i class="far fa-dot-circle"></i></a></li>
          <li class='c-panels__li'><a class='c-panels__link' href='' title=''><i class="fas fa-chart-bar"></i></a></li>
          <li class='c-panels__li'><a class='c-panels__link' href='' title=''><i class="far fa-comments"></i></a></li>
          <li class='c-panels__li'><a class='c-panels__link' href='' title=''><i class="fab fa-app-store"></i></a></li>
          <li class='c-panels__li'><a class='c-panels__link' href='' title=''><i class="fas fa-asterisk"></i></a></li>
          <li class='c-panels__li'><a class='c-panels__link' href='' title=''><i class="fab fa-bandcamp"></i></a></li>
          <li class='c-panels__li'><a class='c-panels__link' href='' title=''><i class="far fa-address-book"></i></a></li>
        </ul>
      </nav>
    </div>
    <div class='c-users'>
      
     
      
      <h2 class='c-group-title'>Direct Messages <i class="fas fa-plus"></i></h2>
      <ul class='c-users__people' id="myul" >
        <li class='c-users__person'>Jeremy Firow</li>
        <li class='c-users__person'>Mariuz Jaders</li>
        <li class='c-users__person'>Emil Anders</li>
        <li class='c-users__person'>Markus Gavrilov</li>
      </ul>
      
      <h2 class='c-group-title'>Groups <i class="fas fa-plus"></i></h2>
      <ul class='c-tags' > 
        <li><i class="fas fa-hashtag"></i>Crypto</li>
        <li><i class="fas fa-hashtag"></i>Futures</li>
        <li><i class="fas fa-hashtag"></i>Finance</li>
        <li><i class="fas fa-hashtag"></i>Stocktalk Germany</li>
      </ul>
    </div>
  </aside>
  <section class='c-chat'>
    <header class='c-chat__header'>
      <div class='c-chat__title'>
        <h1><i class="fas fa-hashtag"></i> Pelican Room</h1>
        <p>6 Members</p><button><i class="fas fa-plus"></i> Add Member</button>
      </div>
      <div class='c-chat__options'></div>
    </header>
    <div class='c-chat__window'  id="chat" >
    

  </section>
      <input class='c-users__search' type='text' placeholder='Type here to send your message ' id="send" >

  <div class='c-chat-info'>
    <header class='c-chat__header c-chat__header--left'>
      <div class='c-chat__title'>
        <h2><i class="fas fa-hashtag"></i> Group Info</h2>
        <p>Created 2/22/2221</p>
      </div>
      
    </header>
    <div class='c-chat__options'>
     <h2 class='c-group-title'>Members <i class="fas fa-chevron-down"></i></h2>
      <ul class='c-users__people'>
       
        <li class='c-users__person'>Markus Gavrilov</li>
        <li class='c-users__person'>Mariuz Jaders</li>
        <li class='c-users__person'>Jeremy Firow</li>
        <li class='c-users__person'>Emil Anders</li>
        
      </ul>
    
     <h2 class='c-group-title'>Shared Files <i class="fas fa-chevron-right"></i></h2>
    <h2 class='c-group-title'>Pinned Messages <i class="fas fa-chevron-right"></i></h2>
    <h2 class='c-group-title'>Starred Files <i class="fas fa-chevron-right"></i></h2>
<button onclick="send()" >  di </button>

  </div>
    </div>
</main>
</body>
</html>

<script type="text/babel">


 
   const token = JSON.parse(localStorage.getItem('decoded_token'));
console.log("my token "+token.firstName)
let newSocket = new WebSocket("ws://localhost:3000/api/chats?id="+token);
let selectedUser ; 


newSocket.onmessage = function(message) {
console.log("hi")
message=JSON.parse(message.data)

var result = "";

if(message.sender===token.user_id){

     result += " <div class='c-chat__msg'><span class='c-chat__icon'></span><div class='c-chat__text'><span> "+ token.firstName+" </span><time>"+message.date+"</time><p>"+message.content+"</p></div></div>";
}else{
     result += " <div class='c-chat__msg'><span class='c-chat__icon'></span><div class='c-chat__text'><span> "+ selectedUser.firstName +" </span><time>12:49pm</time><p>"+message.content+"</p></div></div>";

}
result +="</div>"
  $('#chat').append(result);
};
const chat:chat = new chat(token)

chat.fetchUsermessage()

const users= JSON.parse( localStorage.getItem('displayusers')) ;
const messages= JSON.parse( localStorage.getItem('messages')) ;
var ul = document.getElementById("myul")
var j = 0 ;
for( var i of users ){
  var li = document.createElement("li");
  li.className="c-users__person"
  li.id=""+j;
  var text= document.createTextNode(i.firstName); 
  ul.appendChild(li).appendChild(text)
j++;
}

ul.addEventListener('click', function(e) {
  e.preventDefault()
selectedUser= users[e.target.id] ;
    if (e.target.tagName === 'LI'){
        
  var result = "";
  $(messages).each(function (key, message) {
if(message.sender.id===token.user_id){

     result += " <div class='c-chat__msg'><span class='c-chat__icon'></span><div class='c-chat__text'><span> "+ token.firstName+" </span><time>"+message.date+"</time><p>"+message.content+"</p></div></div>";
}else{
     result += " <div class='c-chat__msg'><span class='c-chat__icon'></span><div class='c-chat__text'><span> "+ users[e.target.id].firstName+" </span><time>12:49pm</time><p>"+message.content+"</p></div></div>";

}


});
result +="</div>"
  $('#chat').append(result);

    }
});


function send() {

var content = document.getElementById("send").value


newSocket.send(JSON.stringify(
        {
          content: content,
          sender: token.user_id,
          receiver: users[0].id
        }
      ));

}   


</script>